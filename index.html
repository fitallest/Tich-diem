<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T√≠ch ƒêi·ªÉm S∆°n T·ªët VN</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, getDocs, query, where, serverTimestamp, runTransaction, onSnapshot, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYZT7Lxsckock5kv0RIZ3W8JHe2W8CMLE",
            authDomain: "tichdiemson.firebaseapp.com",
            projectId: "tichdiemson",
            storageBucket: "tichdiemson.firebasestorage.app",
            messagingSenderId: "373606094714",
            appId: "1:373606094714:web:05bbe440475431f693e8c3",
            measurementId: "G-YQJTGE1JV6"
        };
        
        const appId = 'tichdiemson-app';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.fb = {
            auth, db, appId,
            signInAnonymously, onAuthStateChanged,
            collection, addDoc, updateDoc, doc, getDoc, getDocs, query, where, serverTimestamp, runTransaction, onSnapshot, orderBy, limit
        };

        signInAnonymously(auth).catch(e => console.error("Login Error:", e));
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.9); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 300ms, transform 300ms; }
        .modal-exit { opacity: 1; }
        .modal-exit-active { opacity: 0; transition: opacity 200ms; }

        /* Scanner Optimization */
        #reader { width: 100%; height: 100%; background: #000; }
        #reader video { 
            object-fit: cover; 
            width: 100%; 
            height: 100%; 
            border-radius: 0;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden text-gray-800">

    <div id="root" class="h-full w-full max-w-md mx-auto bg-white shadow-2xl relative flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const formatMoney = (n) => new Intl.NumberFormat('vi-VN').format(n);

        // --- COMPONENTS ---
        const Loading = ({ msg }) => (
            <div className="fixed inset-0 bg-black/60 z-[60] flex flex-col items-center justify-center text-white backdrop-blur-sm">
                <i className="fa-solid fa-circle-notch fa-spin text-4xl mb-3"></i>
                <span className="font-medium">{msg}</span>
            </div>
        );

        const Modal = ({ title, type, children, onClose }) => (
            <div className="fixed inset-0 bg-black/70 z-[70] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
                    <div className={`p-4 flex items-center justify-between ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'} text-white`}>
                        <h3 className="font-bold text-lg">{title}</h3>
                        <button onClick={onClose} className="w-8 h-8 flex items-center justify-center rounded-full bg-white/20 hover:bg-white/30"><i className="fa-solid fa-xmark"></i></button>
                    </div>
                    <div className="p-6">
                        {children}
                        <button onClick={onClose} className="w-full mt-6 py-3 rounded-xl font-bold bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors shadow-sm border border-gray-300">
                            {type === 'success' ? 'ƒê√≥ng' : 'ƒê√≥ng'}
                        </button>
                    </div>
                </div>
            </div>
        );

        // --- LOGIN SCREEN ---
        const LoginScreen = ({ onLogin }) => {
            const [phone, setPhone] = useState('');
            const [name, setName] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!phone || !name) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
                setLoading(true);
                try {
                    const { db, collection, query, where, getDocs, addDoc, serverTimestamp, appId } = window.fb;
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'members'), where('phone', '==', phone));
                    const snapshot = await getDocs(q);
                    
                    let userData;
                    if (!snapshot.empty) {
                        userData = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                    } else {
                        const newDoc = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'members'), {
                            name: name, phone: phone, points: 0, rank: 'member', joinDate: new Date().toLocaleDateString('vi-VN'), createdAt: serverTimestamp()
                        });
                        userData = { id: newDoc.id, name, phone, points: 0, rank: 'member' };
                    }
                    localStorage.setItem('paint_user', JSON.stringify(userData));
                    onLogin(userData);
                } catch (err) { alert("L·ªói: " + err.message); } 
                finally { setLoading(false); }
            };

            return (
                <div className="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-blue-600 to-blue-800 text-white">
                    <div className="w-20 h-20 bg-white rounded-2xl flex items-center justify-center text-blue-600 text-3xl font-bold mb-6 shadow-lg">ST</div>
                    <h1 className="text-2xl font-bold mb-2">Xin ch√†o Th·ª£ S∆°n!</h1>
                    <p className="text-blue-100 mb-8">Nh·∫≠p th√¥ng tin ƒë·ªÉ t√≠ch ƒëi·ªÉm</p>
                    <form onSubmit={handleSubmit} className="w-full bg-white/10 backdrop-blur-md p-6 rounded-2xl border border-white/20">
                        <div className="space-y-4">
                            <div><label className="text-xs uppercase font-bold text-blue-200 ml-1">S·ªë ƒëi·ªán tho·∫°i</label><input type="tel" className="w-full mt-1 p-3 rounded-xl bg-white/90 text-gray-900 font-bold" placeholder="09xxxxxxx" value={phone} onChange={e => setPhone(e.target.value)} /></div>
                            <div><label className="text-xs uppercase font-bold text-blue-200 ml-1">H·ªç v√† T√™n</label><input type="text" className="w-full mt-1 p-3 rounded-xl bg-white/90 text-gray-900" placeholder="Nguy·ªÖn VƒÉn A" value={name} onChange={e => setName(e.target.value)} /></div>
                            <button type="submit" className="w-full py-4 bg-yellow-400 text-blue-900 font-bold rounded-xl mt-4 flex justify-center items-center gap-2">{loading ? <i className="fa-solid fa-spinner fa-spin"></i> : "B·∫ÆT ƒê·∫¶U"}</button>
                        </div>
                    </form>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('home'); // home, rewards
            const [isScanning, setIsScanning] = useState(false); // Controls Scanner Overlay
            const [points, setPoints] = useState(0);
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(false);
            const [modal, setModal] = useState(null);
            const [manualCode, setManualCode] = useState('');
            const [filterType, setFilterType] = useState('all'); // all, scan, redeem
            const [rewards, setRewards] = useState([]); // Dynamic Rewards
            
            const scannerRef = useRef(null);
            const processingRef = useRef(false); // Lock for scanner

            // Initial Login Check
            useEffect(() => {
                const stored = localStorage.getItem('paint_user');
                if (stored) setUser(JSON.parse(stored));
            }, []);
            
            // --- AUTO PROCESS CODE FROM URL ---
            useEffect(() => {
                if (user && !processingRef.current) {
                    const params = new URLSearchParams(window.location.search);
                    const codeFromUrl = params.get('c');
                    
                    if (codeFromUrl) {
                        window.history.replaceState({}, document.title, window.location.pathname);
                        console.log("Auto processing code:", codeFromUrl);
                        processCode(codeFromUrl);
                    }
                }
            }, [user]);

            // Realtime Listeners
            useEffect(() => {
                if (!user || !window.fb) return;
                const { db, doc, onSnapshot, collection, query, where, orderBy, limit, appId } = window.fb;

                const unsubUser = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'members', user.id), (doc) => {
                    if (doc.exists()) setPoints(doc.data().points || 0);
                });

                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'scan_history'), where('user_phone', '==', user.phone), limit(50));
                const unsubHist = onSnapshot(q, (snap) => {
                    let data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    setHistory(data);
                }, (err) => console.log('History error safe catch'));
                
                const unsubRewards = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'reward_templates'), (snap) => {
                     const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                     data.sort((a, b) => (a.points || 0) - (b.points || 0));
                     setRewards(data);
                }, (err) => console.log('Rewards error safe catch'));

                return () => { unsubUser(); unsubHist(); unsubRewards(); };
            }, [user]);
            
            // --- SCANNER LIFECYCLE MANAGEMENT (IOS FIXED) ---
            useEffect(() => {
                let html5QrCode;
                let isMounted = true;
                let fixIosInterval = null; // Bi·∫øn ƒë·ªÉ l∆∞u v√≤ng l·∫∑p fix l·ªói iOS

                if (isScanning) {
                    const timer = setTimeout(() => {
                        if (!isMounted) return;
                        const readerElem = document.getElementById("reader");
                        if (!readerElem) {
                            setIsScanning(false);
                            return;
                        }

                        try {
                            readerElem.innerHTML = "";
                            
                            // T·∫°o instance m·ªõi
                            html5QrCode = new Html5Qrcode("reader");
                            scannerRef.current = html5QrCode;
                            
                            // C·∫§U H√åNH FIX CHO IOS
                            const config = { 
                                fps: 10, // Gi·∫£m FPS xu·ªëng 10 ƒë·ªÉ nh·∫π m√°y h∆°n tr√™n iOS
                                qrbox: { width: 250, height: 250 }, // ƒê·ªãnh v√πng qu√©t r√µ r√†ng
                                aspectRatio: 1.0, // Quan tr·ªçng: T·ªâ l·ªá 1:1 gi√∫p iOS kh√¥ng b·ªã m√©o h√¨nh
                                experimentalFeatures: {
                                    useBarCodeDetectorIfSupported: true
                                },
                                videoConstraints: {
                                    facingMode: "environment",
                                    // B·ªè focusMode continuous v√¨ m·ªôt s·ªë iOS b·ªã l·ªói m√†n h√¨nh ƒëen
                                    aspectRatio: 1.0 
                                }
                            };
                            
                            // H√ÄM FIX L·ªñI VIDEO PLAYER TR√äN IOS
                            // Ch·∫°y li√™n t·ª•c ki·ªÉm tra xem th·∫ª <video> ƒë√£ hi·ªán ra ch∆∞a ƒë·ªÉ th√™m thu·ªôc t√≠nh playsinline
                            fixIosInterval = setInterval(() => {
                                const videoElement = document.querySelector('#reader video');
                                if (videoElement) {
                                    if (!videoElement.hasAttribute('playsinline')) {
                                        videoElement.setAttribute('playsinline', 'true');
                                        videoElement.setAttribute('webkit-playsinline', 'true');
                                    }
                                    // Fix CSS ƒë·ªÉ video l·∫•p ƒë·∫ßy khung m√† kh√¥ng b·ªã thanh ƒëi·ªÅu khi·ªÉn che
                                    videoElement.style.objectFit = "cover"; 
                                }
                            }, 500);

                            html5QrCode.start(
                                { facingMode: "environment" }, 
                                config,
                                (decodedText) => {
                                    if(navigator.vibrate) navigator.vibrate(200);
                                    // T·∫Øt scanner ngay khi qu√©t ƒë∆∞·ª£c ƒë·ªÉ tr√°nh qu√©t nhi·ªÅu l·∫ßn
                                    setIsScanning(false); 
                                    processCode(decodedText);
                                },
                                (errorMessage) => { /* B·ªè qua l·ªói t·ª´ng frame */ }
                            ).catch(err => {
                                console.error("Start failed", err);
                                let errorMsg = "Kh√¥ng th·ªÉ b·∫≠t camera.";
                                let isSecure = window.isSecureContext;

                                if (err.name === "NotAllowedError" || err.message?.includes("Permission")) {
                                    errorMsg = "Quy·ªÅn truy c·∫≠p Camera b·ªã ch·∫∑n. Vui l√≤ng v√†o C√†i ƒë·∫∑t > Safari > Camera > Cho ph√©p.";
                                } else if (err.name === "NotFoundError") {
                                    errorMsg = "Kh√¥ng t√¨m th·∫•y Camera.";
                                } else if (!isSecure && location.hostname !== 'localhost') {
                                    errorMsg = "L·ªñI: Camera y√™u c·∫ßu HTTPS.";
                                }

                                setModal({
                                    type: 'error',
                                    title: 'L·ªói Camera',
                                    content: (<div className="text-center"><p>{errorMsg}</p></div>)
                                });
                                setIsScanning(false);
                            });
                        } catch (e) {
                            console.error("Init failed", e);
                            setIsScanning(false);
                        }
                    }, 100);

                    return () => {
                        isMounted = false;
                        clearTimeout(timer);
                        if (fixIosInterval) clearInterval(fixIosInterval); // X√≥a v√≤ng l·∫∑p fix iOS
                        
                        if (html5QrCode && html5QrCode.isScanning) {
                            html5QrCode.stop().then(() => html5QrCode.clear()).catch(console.error);
                        }
                    };
                }
            }, [isScanning]);


            const canRedeemAny = useMemo(() => {
                return rewards.some(r => points >= r.points);
            }, [points, rewards]);

            const filteredHistory = useMemo(() => {
                if (filterType === 'all') return history;
                if (filterType === 'scan') return history.filter(item => !item.action.includes('redeem'));
                if (filterType === 'redeem') return history.filter(item => item.action.includes('redeem'));
                return history;
            }, [history, filterType]);

            // --- ACTIONS ---
            const handleLogout = () => { if(confirm("ƒêƒÉng xu·∫•t?")) { localStorage.removeItem('paint_user'); setUser(null); } };

            const processCode = async (codeStr) => {
                if (processingRef.current) return;
                processingRef.current = true; // Lock

                let finalCode = codeStr.includes('=') ? codeStr.split('=').pop() : codeStr;
                finalCode = finalCode.trim().toUpperCase();

                if (!finalCode) { processingRef.current = false; return; }

                setLoading(true);

                try {
                    const { db, doc, runTransaction, serverTimestamp, collection, addDoc, appId } = window.fb;
                    const tempCodeRef = doc(db, 'artifacts', appId, 'public', 'data', 'qr_codes', finalCode);
                    const memberRef = doc(db, 'artifacts', appId, 'public', 'data', 'members', user.id);
                    const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'scan_history');

                    const result = await runTransaction(db, async (transaction) => {
                        const codeDoc = await transaction.get(tempCodeRef);
                        const memberDoc = await transaction.get(memberRef);

                        if (!codeDoc.exists()) throw { message: "M√£ kh√¥ng t·ªìn t·∫°i." };
                        const codeData = codeDoc.data();
                        if (codeData.status === 'used') throw { message: "M√£ ƒë√£ s·ª≠ d·ª•ng." };
                        if (codeData.status !== 'active') throw { message: "M√£ ch∆∞a k√≠ch ho·∫°t." };

                        const newPoints = (codeData.points || 0);
                        const currentPoints = memberDoc.exists() ? (memberDoc.data().points || 0) : 0;

                        transaction.update(tempCodeRef, { status: 'used', usedBy: user.id, usedAt: serverTimestamp() });
                        transaction.update(memberRef, { points: currentPoints + newPoints });
                        return { points: newPoints };
                    });

                    await addDoc(historyRef, {
                        user_name: user.name, user_phone: user.phone, code: finalCode, action: 'scan', 
                        points: result.points, timestamp: serverTimestamp(), status: 'success'
                    });

                    setModal({
                        type: 'success',
                        title: 'Th√†nh c√¥ng!',
                        content: (
                            <div className="text-center">
                                <div className="text-6xl mb-4 animate-bounce">üéâ</div>
                                <p className="text-gray-600">B·∫°n nh·∫≠n ƒë∆∞·ª£c</p>
                                <p className="text-4xl font-bold text-green-600">+{result.points} ƒêi·ªÉm</p>
                            </div>
                        )
                    });

                } catch (err) {
                    setModal({
                        type: 'error',
                        title: 'Th·∫•t b·∫°i',
                        content: (
                            <div className="text-center">
                                <div className="text-5xl mb-4 text-red-500"><i className="fa-solid fa-circle-xmark"></i></div>
                                <p className="font-medium">{err.message || "L·ªói h·ªá th·ªëng"}</p>
                                <p className="text-sm text-gray-500 mt-2">M√£: {finalCode}</p>
                            </div>
                        )
                    });
                } finally {
                    setLoading(false);
                    setManualCode('');
                }
            };

            const handleRedeem = async (reward) => {
                if (points < reward.points) return alert("B·∫°n ch∆∞a ƒë·ªß ƒëi·ªÉm!");
                if (!confirm(`X√°c nh·∫≠n ƒë·ªïi: ${reward.name}?\nB·∫°n s·∫Ω b·ªã tr·ª´ ${formatMoney(reward.points)} ƒëi·ªÉm.`)) return;

                setLoading(true);
                try {
                    const { db, doc, runTransaction, serverTimestamp, collection, addDoc, appId } = window.fb;
                    const memberRef = doc(db, 'artifacts', appId, 'public', 'data', 'members', user.id);
                    const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'scan_history');

                    await runTransaction(db, async (transaction) => {
                        const memberDoc = await transaction.get(memberRef);
                        const currentPoints = memberDoc.data().points || 0;
                        if (currentPoints < reward.points) throw { message: "Kh√¥ng ƒë·ªß ƒëi·ªÉm s·ªë d∆∞" };
                        
                        transaction.update(memberRef, { points: currentPoints - reward.points });
                    });

                    await addDoc(historyRef, {
                        user_name: user.name, user_phone: user.phone, action: 'redeem_gift',
                        gift_name: reward.name, points_deducted: reward.points, 
                        timestamp: serverTimestamp(), status: 'pending_approval'
                    });

                    setModal({
                        type: 'success',
                        title: 'Y√™u c·∫ßu ƒë√£ g·ª≠i!',
                        content: (
                            <div className="text-center">
                                <div className="text-5xl mb-4 text-blue-500"><i className="fa-solid fa-hourglass-half fa-spin-pulse"></i></div>
                                <p className="text-gray-700 font-bold">ƒêang ch·ªù duy·ªát</p>
                                <p className="text-sm text-gray-500 mt-2">Y√™u c·∫ßu ƒë·ªïi <b>{reward.name}</b> ƒë√£ ƒë∆∞·ª£c g·ª≠i. Ch√∫ng t√¥i s·∫Ω th√¥ng b√°o khi qu√† ƒë∆∞·ª£c giao.</p>
                            </div>
                        )
                    });
                    setFilterType('redeem');
                } catch (err) {
                    alert("L·ªói: " + err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            const handleConfirmReceipt = async (historyId) => {
                 if (!confirm("X√°c nh·∫≠n b·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c qu√†?")) return;
                 setLoading(true);
                 try {
                     const { db, doc, updateDoc, appId } = window.fb;
                     const historyRef = doc(db, 'artifacts', appId, 'public', 'data', 'scan_history', historyId);
                     await updateDoc(historyRef, { status: 'completed' });
                     alert("C·∫£m ∆°n b·∫°n! Tr·∫°ng th√°i ƒë√£ c·∫≠p nh·∫≠t.");
                 } catch(err) {
                     alert("L·ªói: " + err.message);
                 } finally {
                     setLoading(false);
                 }
            };

            const toggleScanner = () => {
                if (isScanning) {
                    setIsScanning(false);
                } else {
                    setIsScanning(true);
                    processingRef.current = false;
                }
            };

            const closeModal = () => {
                setModal(null);
                processingRef.current = false;
            };

            if (!user) return <LoginScreen onLogin={setUser} />;

            return (
                <div className="flex flex-col h-full bg-gray-50 relative">
                    {loading && <Loading msg="ƒêang x·ª≠ l√Ω..." />}
                    {modal && <Modal title={modal.title} type={modal.type} onClose={closeModal}>{modal.content}</Modal>}

                    {/* MAIN CONTENT AREA */}
                    <div className="flex-1 overflow-hidden flex flex-col pb-20">
                        {/* HEADER */}
                        <div className="bg-blue-600 text-white p-6 pb-10 rounded-b-3xl shadow-lg relative z-10 shrink-0">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center font-bold border border-white/30"><i className="fa-solid fa-user"></i></div>
                                    <div className="leading-tight">
                                        <div className="font-bold">{user.name}</div>
                                        <div className="text-blue-200 text-xs">{user.phone}</div>
                                    </div>
                                </div>
                                <button onClick={handleLogout} className="text-blue-200 hover:text-white"><i className="fa-solid fa-right-from-bracket"></i></button>
                            </div>
                            <div className="text-center">
                                <div className="text-blue-100 text-xs uppercase tracking-wide">ƒêi·ªÉm t√≠ch l≈©y</div>
                                <div className="text-5xl font-bold tracking-tight text-white drop-shadow-md">{formatMoney(points)}</div>
                            </div>
                        </div>

                        {/* TABS CONTENT */}
                        <div className="flex-1 overflow-y-auto -mt-6 pt-8 px-4 relative z-0">
                            {activeTab === 'home' ? (
                                <div className="space-y-6 pb-6">
                                    {/* Action Card */}
                                    <div className="bg-white rounded-2xl shadow-md p-4 flex gap-4">
                                        <button onClick={toggleScanner} className="flex-1 bg-yellow-400 text-blue-900 py-3 rounded-xl font-bold flex flex-col items-center gap-1 shadow-sm active:scale-95 transition-transform">
                                            <i className="fa-solid fa-qrcode text-xl"></i> Qu√©t M√£
                                        </button>
                                        <div className="flex-1 flex flex-col justify-center gap-2">
                                            <div className="text-xs font-bold text-gray-500 uppercase">Nh·∫≠p tay</div>
                                            <div className="flex gap-2">
                                                <input type="text" className="w-full bg-gray-100 rounded px-2 text-sm uppercase border border-gray-200" placeholder="CODE" value={manualCode} onChange={e => setManualCode(e.target.value)} />
                                                <button onClick={() => processCode(manualCode)} className="bg-blue-600 text-white w-8 rounded flex items-center justify-center"><i className="fa-solid fa-arrow-right"></i></button>
                                            </div>
                                        </div>
                                    </div>

                                    {/* History */}
                                    <div>
                                        <div className="flex justify-between items-center mb-3">
                                            <h3 className="font-bold text-gray-700 flex items-center gap-2"><i className="fa-solid fa-clock-rotate-left text-blue-500"></i> L·ªãch s·ª≠</h3>
                                            
                                            {/* History Filters */}
                                            <div className="flex bg-gray-200 rounded-lg p-0.5">
                                                <button onClick={() => setFilterType('all')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${filterType === 'all' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>T·∫•t c·∫£</button>
                                                <button onClick={() => setFilterType('scan')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${filterType === 'scan' ? 'bg-white shadow text-green-600' : 'text-gray-500'}`}>N·∫°p ƒëi·ªÉm</button>
                                                <button onClick={() => setFilterType('redeem')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${filterType === 'redeem' ? 'bg-white shadow text-red-600' : 'text-gray-500'}`}>ƒê·ªïi qu√†</button>
                                            </div>
                                        </div>

                                        <div className="space-y-3">
                                            {filteredHistory.length === 0 ? <p className="text-center text-gray-400 py-4 text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu.</p> : 
                                            filteredHistory.map((item, idx) => (
                                                <div key={idx} className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex flex-col gap-2">
                                                    <div className="flex justify-between items-center">
                                                        <div className="flex items-center gap-3">
                                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${item.action.includes('redeem') ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-500'}`}>
                                                                <i className={`fa-solid ${item.action.includes('redeem') ? 'fa-gift' : 'fa-check'}`}></i>
                                                            </div>
                                                            <div>
                                                                <div className="font-bold text-gray-800 text-sm">{item.action.includes('redeem') ? `ƒê·ªïi: ${item.gift_name}` : `M√£: ${item.code}`}</div>
                                                                <div className="text-xs text-gray-400">{item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleString('vi-VN') : '...'}</div>
                                                            </div>
                                                        </div>
                                                        <div className={`font-bold ${item.action.includes('redeem') ? 'text-red-500' : 'text-green-600'}`}>
                                                            {item.action.includes('redeem') ? '-' : '+'}{item.points || item.points_deducted}
                                                        </div>
                                                    </div>
                                                    {item.action === 'redeem_gift' && (
                                                        <div className="ml-12 text-sm border-t border-dashed border-gray-100 pt-2 mt-1">
                                                            <div className="flex justify-between items-center">
                                                                {item.status === 'pending_approval' && <span className="text-orange-500 font-bold bg-orange-100 px-2 py-0.5 rounded text-xs"><i className="fa-solid fa-hourglass-half"></i> Ch·ªù duy·ªát</span>}
                                                                {item.status === 'shipping' && <span className="text-blue-600 font-bold bg-blue-50 px-2 py-0.5 rounded text-xs"><i className="fa-solid fa-truck"></i> ƒêang giao</span>}
                                                                {item.status === 'completed' && <span className="text-green-600 font-bold bg-green-100 px-2 py-0.5 rounded text-xs"><i className="fa-solid fa-check-circle"></i> ƒê√£ nh·∫≠n</span>}
                                                                {item.status === 'success' && <span className="text-green-600 font-bold bg-green-100 px-2 py-0.5 rounded text-xs"><i className="fa-solid fa-check-circle"></i> Th√†nh c√¥ng</span>}
                                                                
                                                                {item.status === 'shipping' && (
                                                                    <button onClick={() => handleConfirmReceipt(item.id)} className="bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-1.5 rounded-lg font-bold shadow animate-pulse">
                                                                        ƒê√£ nh·∫≠n qu√†
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-4 pb-6">
                                    <h3 className="font-bold text-gray-700 text-center uppercase tracking-wide">Kho Qu√† T·∫∑ng</h3>
                                    <div className="grid grid-cols-1 gap-4">
                                        {rewards.length === 0 ? <p className="text-center text-gray-400 text-sm">Ch∆∞a c√≥ qu√† n√†o ƒë∆∞·ª£c c·∫≠p nh·∫≠t.</p> :
                                        rewards.map(reward => (
                                            <div key={reward.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                                                <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-2xl ${reward.color}`}>
                                                    <i className={`fa-solid ${reward.icon}`}></i>
                                                </div>
                                                <div className="flex-1">
                                                    <div className="font-bold text-gray-800">{reward.name}</div>
                                                    <div className="text-blue-600 font-bold text-sm">{formatMoney(reward.points)} ƒëi·ªÉm</div>
                                                </div>
                                                <button 
                                                    onClick={() => handleRedeem(reward)}
                                                    disabled={points < reward.points}
                                                    className={`px-4 py-2 rounded-lg font-bold text-xs ${points >= reward.points ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}
                                                >
                                                    ƒê·ªïi ngay
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* BOTTOM NAV */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-2 safe-area-bottom z-40 flex justify-between items-center text-xs font-bold text-gray-400">
                        <button onClick={() => { setActiveTab('home'); setIsScanning(false); }} className={`flex flex-col items-center gap-1 p-2 ${activeTab === 'home' && !isScanning ? 'text-blue-600' : ''}`}>
                            <i className="fa-solid fa-house text-xl"></i> Trang ch·ªß
                        </button>
                        
                        <div className="relative -top-6">
                            <button onClick={toggleScanner} className="bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:bg-blue-700 transform transition-transform active:scale-90 border-4 border-gray-50">
                                <i className="fa-solid fa-qrcode text-2xl"></i>
                            </button>
                        </div>
                        
                        <button onClick={() => { setActiveTab('rewards'); setIsScanning(false); }} className={`relative flex flex-col items-center gap-1 p-2 ${activeTab === 'rewards' ? 'text-blue-600' : ''}`}>
                            <i className="fa-solid fa-gift text-xl"></i> ƒê·ªïi qu√†
                            {canRedeemAny && <span className="absolute top-1 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border border-white"></span>}
                         </button>
                    </div>

                    {/* SCANNER OVERLAY (FULLSCREEN) */}
                    {isScanning && (
                        <div className="fixed inset-0 z-50 bg-black flex flex-col animate-fade-in">
                            <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-10">
                                <div className="bg-black/40 text-white px-3 py-1 rounded-full text-sm backdrop-blur-md">Qu√©t m√£ QR</div>
                                <button onClick={toggleScanner} className="w-10 h-10 bg-white/20 rounded-full text-white flex items-center justify-center backdrop-blur-md"><i className="fa-solid fa-xmark"></i></button>
                            </div>
                            
                            {/* CAMERA CONTAINER */}
                            <div className="flex-1 bg-black relative flex flex-col items-center justify-center overflow-hidden">
                                {/* The scanner video goes here. WE DO NOT PUT OVERLAYS INSIDE HERE */}
                                <div id="reader"></div>
                                
                                {/* CUSTOM OVERLAY - PLACED OUTSIDE READER DIV BUT ABSOLUTE POSITIONED OVER IT */}
                                <div className="absolute inset-0 pointer-events-none flex items-center justify-center z-20">
                                    <div className="w-64 h-64 border-2 border-yellow-400 rounded-lg relative opacity-80 shadow-[0_0_0_9999px_rgba(0,0,0,0.5)]">
                                        <div className="absolute top-0 left-0 w-4 h-4 border-l-4 border-t-4 border-yellow-400 -ml-1 -mt-1"></div>
                                        <div className="absolute top-0 right-0 w-4 h-4 border-r-4 border-t-4 border-yellow-400 -mr-1 -mt-1"></div>
                                        <div className="absolute bottom-0 left-0 w-4 h-4 border-l-4 border-b-4 border-yellow-400 -ml-1 -mb-1"></div>
                                        <div className="absolute bottom-0 right-0 w-4 h-4 border-r-4 border-b-4 border-yellow-400 -mr-1 -mb-1"></div>
                                    </div>
                                </div>
                                
                                <div className="absolute bottom-20 left-0 right-0 text-center text-white/80 text-sm z-20">Di chuy·ªÉn camera v√†o m√£ QR</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
