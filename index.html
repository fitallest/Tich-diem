
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T√≠ch ƒêi·ªÉm S∆°n T·ªët VN</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- 2. React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- Firebase Config -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, getDocs, query, where, serverTimestamp, runTransaction, onSnapshot, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // C·∫•u h√¨nh d·ª± √°n tichdiemson (D√πng chung v·ªõi Admin)
        const firebaseConfig = {
            apiKey: "AIzaSyBYZT7Lxsckock5kv0RIZ3W8JHe2W8CMLE",
            authDomain: "tichdiemson.firebaseapp.com",
            projectId: "tichdiemson",
            storageBucket: "tichdiemson.firebasestorage.app",
            messagingSenderId: "373606094714",
            appId: "1:373606094714:web:05bbe440475431f693e8c3",
            measurementId: "G-YQJTGE1JV6"
        };
        
        // ID ·ª®ng d·ª•ng ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi trang Admin
        const appId = 'tichdiemson-app';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose to Window
        window.fb = {
            auth, db, appId,
            signInAnonymously, onAuthStateChanged,
            collection, addDoc, updateDoc, doc, getDoc, getDocs, query, where, serverTimestamp, runTransaction, onSnapshot, orderBy, limit
        };

        // Auto Login Anonymous ƒë·ªÉ k·∫øt n·ªëi DB
        signInAnonymously(auth).catch(e => {
            console.error("Login Error:", e);
            if (e.code === 'auth/configuration-not-found' || e.code === 'auth/operation-not-allowed') {
                window.authError = e; 
            }
        });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        /* Scanner UI Customization */
        #reader { width: 100%; border-radius: 12px; overflow: hidden; }
        #reader video { object-fit: cover; border-radius: 12px; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden text-gray-800">

    <div id="root" class="h-full w-full max-w-md mx-auto bg-white shadow-2xl relative flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const formatMoney = (n) => new Intl.NumberFormat('vi-VN').format(n);

        // --- COMPONENTS ---
        const Loading = ({ msg }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex flex-col items-center justify-center text-white backdrop-blur-sm">
                <i className="fa-solid fa-circle-notch fa-spin text-4xl mb-3"></i>
                <span className="font-medium">{msg}</span>
            </div>
        );

        const Modal = ({ title, type, children, onClose }) => (
            <div className="fixed inset-0 bg-black/50 z-40 flex items-center justify-center p-4 backdrop-blur-sm animate-fade">
                <div className="bg-white w-full max-w-sm rounded-2xl shadow-xl overflow-hidden animate-scale">
                    <div className={`p-4 flex items-center justify-between ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'} text-white`}>
                        <h3 className="font-bold text-lg">{title}</h3>
                        <button onClick={onClose}><i className="fa-solid fa-xmark text-xl"></i></button>
                    </div>
                    <div className="p-6">
                        {children}
                        <button onClick={onClose} className="w-full mt-6 py-3 rounded-xl font-bold bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors">ƒê√≥ng</button>
                    </div>
                </div>
            </div>
        );

        // --- LOGIN SCREEN ---
        const LoginScreen = ({ onLogin }) => {
            const [phone, setPhone] = useState('');
            const [name, setName] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!phone || !name) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
                
                setLoading(true);
                try {
                    const { db, collection, query, where, getDocs, addDoc, serverTimestamp, appId } = window.fb;
                    
                    // 1. Ki·ªÉm tra SƒêT ƒë√£ t·ªìn t·∫°i ch∆∞a
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'members'), where('phone', '==', phone));
                    const snapshot = await getDocs(q);
                    
                    let userData;
                    if (!snapshot.empty) {
                        // ƒê√£ c√≥ -> ƒêƒÉng nh·∫≠p
                        userData = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                    } else {
                        // Ch∆∞a c√≥ -> T·∫°o m·ªõi
                        const newDoc = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'members'), {
                            name: name,
                            phone: phone,
                            points: 0,
                            rank: 'member',
                            joinDate: new Date().toLocaleDateString('vi-VN'),
                            createdAt: serverTimestamp()
                        });
                        userData = { id: newDoc.id, name, phone, points: 0, rank: 'member' };
                    }
                    
                    localStorage.setItem('paint_user', JSON.stringify(userData));
                    onLogin(userData);
                } catch (err) {
                    alert("L·ªói ƒëƒÉng nh·∫≠p: " + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-blue-600 to-blue-800 text-white">
                    <div className="w-20 h-20 bg-white rounded-2xl flex items-center justify-center text-blue-600 text-3xl font-bold mb-6 shadow-lg">ST</div>
                    <h1 className="text-2xl font-bold mb-2">Xin ch√†o Th·ª£ S∆°n!</h1>
                    <p className="text-blue-100 mb-8 text-center text-sm">Nh·∫≠p th√¥ng tin ƒë·ªÉ t√≠ch ƒëi·ªÉm & nh·∫≠n qu√†</p>
                    
                    <form onSubmit={handleSubmit} className="w-full bg-white/10 backdrop-blur-md p-6 rounded-2xl border border-white/20 shadow-xl">
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs uppercase font-bold text-blue-200 ml-1">S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="tel" className="w-full mt-1 p-3 rounded-xl bg-white/90 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-400 font-bold text-lg tracking-wide" placeholder="09xxxxxxx" value={phone} onChange={e => setPhone(e.target.value)} />
                            </div>
                            <div>
                                <label className="text-xs uppercase font-bold text-blue-200 ml-1">H·ªç v√† T√™n</label>
                                <input type="text" className="w-full mt-1 p-3 rounded-xl bg-white/90 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-400" placeholder="Nguy·ªÖn VƒÉn A" value={name} onChange={e => setName(e.target.value)} />
                            </div>
                            <button type="submit" className="w-full py-4 bg-yellow-400 hover:bg-yellow-300 text-blue-900 font-bold rounded-xl shadow-lg mt-4 transition-transform active:scale-95 flex justify-center items-center gap-2">
                                {loading ? <i className="fa-solid fa-circle-notch fa-spin"></i> : "B·∫ÆT ƒê·∫¶U NGAY"}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home'); // home, scanner
            const [points, setPoints] = useState(0);
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(false);
            const [modal, setModal] = useState(null); 
            const [manualCode, setManualCode] = useState('');
            
            // Refs
            const scannerRef = useRef(null);
            const processingRef = useRef(false); // KH√ìA ƒê·ªÇ CH·ªêNG QU√âT LI√äN T·ª§C

            // 1. Check Login
            useEffect(() => {
                const stored = localStorage.getItem('paint_user');
                if (stored) setUser(JSON.parse(stored));
            }, []);

            // 2. Listen to Realtime Data
            useEffect(() => {
                if (!user || !window.fb) return;
                const { db, doc, onSnapshot, collection, query, where, orderBy, limit, appId } = window.fb;

                // Listen User Doc
                const unsubUser = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'members', user.id), (doc) => {
                    if (doc.exists()) setPoints(doc.data().points || 0);
                });

                // Listen History
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'scan_history'), 
                    where('user_phone', '==', user.phone),
                    limit(5)
                );
                const unsubHist = onSnapshot(q, (snap) => {
                    let data = snap.docs.map(d => d.data());
                    data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    setHistory(data);
                });

                return () => { unsubUser(); unsubHist(); };
            }, [user]);

            // --- FUNCTIONS ---
            const handleLogout = () => {
                if(confirm("B·∫°n mu·ªën ƒëƒÉng xu·∫•t?")) {
                    localStorage.removeItem('paint_user');
                    setUser(null);
                }
            }

            const processCode = async (codeStr) => {
                // [QUAN TR·ªåNG] Ki·ªÉm tra kh√≥a: N·∫øu ƒëang x·ª≠ l√Ω th√¨ ch·∫∑n ngay
                if (processingRef.current) return;
                processingRef.current = true;

                let finalCode = codeStr;
                if (codeStr.includes('=')) finalCode = codeStr.split('=').pop();
                finalCode = finalCode.trim().toUpperCase();

                if (!finalCode) {
                    processingRef.current = false;
                    return;
                }

                setLoading(true);

                // T·∫Øt Camera an to√†n tr∆∞·ªõc khi x·ª≠ l√Ω DB
                if (scannerRef.current) {
                    try {
                        await scannerRef.current.stop();
                        scannerRef.current.clear();
                        scannerRef.current = null;
                    } catch (e) {
                        console.error("Stop error:", e);
                    }
                }
                if (view === 'scanner') setView('home');

                try {
                    const { db, doc, runTransaction, serverTimestamp, collection, addDoc, appId } = window.fb;
                    
                    const tempCodeRef = doc(db, 'artifacts', appId, 'public', 'data', 'qr_codes', finalCode);
                    const memberRef = doc(db, 'artifacts', appId, 'public', 'data', 'members', user.id);
                    const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'scan_history');

                    // TH·ª∞C HI·ªÜN TRANSACTION (ƒê·ªçc tr∆∞·ªõc - Ghi sau)
                    const result = await runTransaction(db, async (transaction) => {
                        // 1. READ ALL FIRST
                        const codeDoc = await transaction.get(tempCodeRef); 
                        const memberDoc = await transaction.get(memberRef);

                        if (!codeDoc.exists()) throw { code: 'not-found', message: "M√£ kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng." };
                        
                        const codeData = codeDoc.data();
                        if (codeData.status === 'used') throw { code: 'used', message: "M√£ n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng r·ªìi!" };
                        if (codeData.status !== 'active') throw { code: 'inactive', message: "M√£ ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t." };

                        const newPoints = (codeData.points || 0);
                        const currentPoints = memberDoc.exists() ? (memberDoc.data().points || 0) : 0;
                        
                        // 2. WRITE ALL LAST
                        transaction.update(tempCodeRef, { 
                            status: 'used',
                            usedBy: user.id,
                            usedAt: serverTimestamp()
                        });
                        transaction.update(memberRef, { points: currentPoints + newPoints });

                        return { points: newPoints };
                    });

                    // Log history (ngo√†i transaction)
                    await addDoc(historyRef, {
                        user_name: user.name,
                        user_phone: user.phone,
                        code: finalCode,
                        action: 'scan',
                        points: result.points,
                        timestamp: serverTimestamp(),
                        status: 'success'
                    });

                    setModal({
                        type: 'success',
                        title: 'T√≠ch ƒëi·ªÉm th√†nh c√¥ng!',
                        content: (
                            <div className="text-center">
                                <div className="text-6xl mb-4">üéâ</div>
                                <p className="text-gray-600 mb-2">B·∫°n v·ª´a nh·∫≠n ƒë∆∞·ª£c</p>
                                <p className="text-4xl font-bold text-green-600 mb-2">+{result.points} ƒêi·ªÉm</p>
                                <p className="text-sm text-gray-500">M√£: {finalCode}</p>
                            </div>
                        )
                    });

                } catch (err) {
                    let displayMsg = "L·ªói h·ªá th·ªëng kh√¥ng x√°c ƒë·ªãnh.";
                    if (err.message) displayMsg = err.message;
                    if (err.code === 'permission-denied') displayMsg = "L·ªói quy·ªÅn truy c·∫≠p (Permission).";
                    
                    setModal({
                        type: 'error',
                        title: 'Th·∫•t b·∫°i',
                        content: (
                            <div className="text-center">
                                <div className="text-5xl mb-4 text-red-500"><i className="fa-solid fa-circle-xmark"></i></div>
                                <p className="text-lg font-medium text-gray-800">{displayMsg}</p>
                                <p className="text-sm text-gray-500 mt-2">M√£: {finalCode}</p>
                            </div>
                        )
                    });

                } finally {
                    setLoading(false);
                    setManualCode('');
                    // M·ªü kh√≥a sau 1 gi√¢y ƒë·ªÉ tr√°nh double-click
                    setTimeout(() => { processingRef.current = false; }, 1000);
                }
            };

            const startScanner = () => {
                setView('scanner');
                // Reset flag khi b·∫Øt ƒë·∫ßu qu√©t m·ªõi
                processingRef.current = false;
                
                setTimeout(() => {
                    const html5QrCode = new Html5Qrcode("reader");
                    scannerRef.current = html5QrCode;
                    html5QrCode.start(
                        { facingMode: "environment" }, 
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        (decodedText) => {
                            // G·ªçi h√†m x·ª≠ l√Ω (ƒë√£ c√≥ kh√≥a b√™n trong)
                            processCode(decodedText);
                        },
                        (errorMessage) => { /* ignore */ }
                    ).catch(err => {
                        alert("Kh√¥ng th·ªÉ m·ªü Camera: " + err);
                        setView('home');
                    });
                }, 100);
            };

            const stopScanner = () => {
                if (scannerRef.current) {
                    scannerRef.current.stop().then(() => {
                        scannerRef.current.clear();
                        scannerRef.current = null;
                    }).catch(console.error);
                }
                setView('home');
            };

            // --- RENDER ---
            if (!user) return <LoginScreen onLogin={setUser} />;

            return (
                <div className="flex flex-col h-full bg-gray-50">
                    {loading && <Loading msg="ƒêang x·ª≠ l√Ω..." />}
                    {modal && <Modal title={modal.title} type={modal.type} onClose={() => setModal(null)}>{modal.content}</Modal>}

                    {/* TOP HEADER */}
                    <div className="bg-blue-600 text-white p-6 pb-12 rounded-b-3xl shadow-lg relative z-10">
                        <div className="flex justify-between items-start mb-6">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-xl font-bold border-2 border-white/30">
                                    <i className="fa-solid fa-user"></i>
                                </div>
                                <div>
                                    <div className="font-bold text-lg">{user.name}</div>
                                    <div className="text-blue-200 text-sm">{user.phone}</div>
                                </div>
                            </div>
                            <button onClick={handleLogout} className="text-blue-200 hover:text-white"><i className="fa-solid fa-right-from-bracket text-xl"></i></button>
                        </div>
                        
                        <div className="text-center">
                            <div className="text-blue-100 text-sm mb-1">T·ªïng ƒëi·ªÉm t√≠ch l≈©y</div>
                            <div className="text-5xl font-bold tracking-tight text-white drop-shadow-md">
                                {formatMoney(points)}
                            </div>
                        </div>
                    </div>

                    {/* MAIN ACTIONS */}
                    <div className="px-4 -mt-8 relative z-20">
                        <div className="bg-white rounded-2xl shadow-xl p-4 flex items-center justify-between gap-4">
                            <button onClick={startScanner} className="flex-1 bg-yellow-400 hover:bg-yellow-300 text-blue-900 py-4 rounded-xl font-bold shadow-sm flex flex-col items-center gap-2 transition-transform active:scale-95">
                                <i className="fa-solid fa-qrcode text-2xl"></i>
                                Qu√©t QR
                            </button>
                            <div className="w-px h-12 bg-gray-200"></div>
                            <div className="flex-1">
                                <div className="text-xs text-gray-500 font-bold mb-1 ml-1 uppercase">Nh·∫≠p m√£ tay</div>
                                <div className="flex gap-2">
                                    <input type="text" className="w-full bg-gray-100 border-0 rounded-lg px-3 py-2 text-sm font-mono uppercase focus:ring-2 focus:ring-blue-500 outline-none" placeholder="CODE..." value={manualCode} onChange={e => setManualCode(e.target.value.toUpperCase())} />
                                    <button onClick={() => processCode(manualCode)} className="bg-blue-600 text-white px-3 rounded-lg"><i className="fa-solid fa-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* HISTORY LIST */}
                    <div className="flex-1 overflow-y-auto px-4 py-6">
                        <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <i className="fa-solid fa-clock-rotate-left text-blue-500"></i> Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
                        </h3>
                        <div className="space-y-3">
                            {history.length === 0 ? (
                                <div className="text-center text-gray-400 py-10">
                                    <i className="fa-solid fa-ghost text-4xl mb-2"></i>
                                    <p>Ch∆∞a c√≥ l·ªãch s·ª≠</p>
                                </div>
                            ) : (
                                history.map((item, idx) => (
                                    <div key={idx} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${item.action === 'redeem_gift' ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-500'}`}>
                                                <i className={`fa-solid ${item.action === 'redeem_gift' ? 'fa-gift' : 'fa-check'}`}></i>
                                            </div>
                                            <div>
                                                <div className="font-bold text-gray-800 text-sm">
                                                    {item.action === 'redeem_gift' ? 'ƒê·ªïi qu√†' : `M√£: ${item.code}`}
                                                </div>
                                                <div className="text-xs text-gray-400">
                                                    {item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleString('vi-VN') : 'V·ª´a xong'}
                                                </div>
                                            </div>
                                        </div>
                                        <div className={`font-bold ${item.action === 'redeem_gift' ? 'text-red-500' : 'text-green-600'}`}>
                                            {item.action === 'redeem_gift' ? '-' : '+'}{item.points || item.points_deducted}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>

                    {/* SCANNER OVERLAY */}
                    {view === 'scanner' && (
                        <div className="fixed inset-0 z-50 bg-black flex flex-col">
                            <div className="p-4 flex justify-between items-center text-white">
                                <h3 className="font-bold text-lg">Qu√©t m√£ QR</h3>
                                <button onClick={stopScanner} className="bg-white/20 p-2 rounded-full w-10 h-10"><i className="fa-solid fa-xmark"></i></button>
                            </div>
                            <div className="flex-1 flex items-center justify-center relative bg-black">
                                <div id="reader"></div>
                                <div className="absolute pointer-events-none border-2 border-yellow-400 w-64 h-64 rounded-xl opacity-50"></div>
                                <p className="absolute bottom-10 text-white/80 text-center w-full">Di chuy·ªÉn camera v√†o m√£ QR</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
